<title>Offline Page Renderer</title>
Offline Page Renderer<br>
<script>
//8-24-15 JChoy v0.2.123 WelcomeApp, getListFromDb
//8-22-15 JChoy pageoff - offline page launcher. This simple page has bootup code stored locally. It sources in cross domain source code as Javascript classes and stores those codes in sql db. Later, it can retrieve and run those source code, which effectively renders the page as an interactive app. 
//TODO: load DbApp and SqlDb into local storage
//-----
function PageOff(){
  this.showId = -1;
  this.start= function(){
	this.initDb();
	if (this.loadUrl) this.srcAndSpawn();
	this.getSpawnAppFromDb();
  }
  this.getSpawnAppFromDb= function(){
	var $privThis = this;
	if (this.showId>=0) 
		return this.getFromDb( this.showId, this.spawnApp );
	if (this.addHtmlApp) {
		HtmlApp = new this.HtmlAppFactory( unescape(this.addHtmlApp) ).nuClass;
		this.storeApp( "HtmlApp", this.addHtmlApp= null );
	}
	this.getMaxNum( function(n){		//run latest app
		$privThis.getFromDb( n, $privThis.spawnApp );
	} );
	this.getListFromDb( function(at){	//install first app
		if (at.length>0) return;
		WelcomeApp = new $privThis.HtmlAppFactory( "Welcome to PageOff" ).nuClass;
		$privThis.storeApp( "WelcomeApp" );
	} );
  }
  this.spawnApp= function(s){
	new AppWrapper().deserialize( s ).spawnApp();
  }
  this.srcAndSpawn= function(){
	var el=document.createElement("script");
	el.src= unescape(this.loadUrl);
	document.body.appendChild(el);

	window[this.clsName]= null;
	this.watchForClass( 50 );
  }
  this.watchForClass = function(n){
	if (n<0) return alert(this.clsName +" not found");
	if (window[this.clsName])
		return this.storeApp(this.clsName);
	var tmr=setTimeout( new OOcallback(this, "watchForClass", n-1).fcna, 100 );
  }
  this.HtmlAppFactory = function(s){
	var code= "this.constructor= PageOff_HtmlApp;\nthis.constructor();\n";
	this.nuClass = new Function( code + "this.text=" +JSON.stringify(s) );
  }
  this.extendClass = function( cls ){ this.extender=cls; this.extender(); }
  this.extendClass( PageOff_ext_cgi );
  this.extendClass( PageOff_ext_sqldb );
}
//-----
PageOff_ext_sqldb= function(){
  this.initDb = function(){
	this.sd = new DbApp();
	this.sd.sql.getPupById= "SELECT * FROM pups WHERE id=?;"
	this.sd.sql.getMaxId= "SELECT max(id) id FROM pups;"
	this.sd.sql.getIds= "SELECT id FROM pups ORDER by id DESC;"
	this.sd.init( "PageOff" );
  }
  this.getListFromDb= function(cb){
	this.sd.getIdsDb( [], function(txn, rs){
		var res=[], colName="";
		if (rs.rows.length==0) return cb(res);
		for (var m in rs.rows.item(0)) colName=m;
		for (var i=0; i<rs.rows.length; i++) res.push(rs.rows.item(i)[colName]);
		cb( res );
	} );
  }
  this.getFromDb= function(i, cb){
	this.sd.getPupByIdDb( [i], function(txn, rs){
		if (rs.rows.length==0) return;
		var colName= "";
		for (var m in rs.rows.item(0)) colName=m;
		cb( rs.rows.item(0)[colName] );
	} );
  }
  this.storeApp= function(name){
	var s = new AppWrapper(name).serialize();
	this.sd.savePupDb( [s], this.resStoreApp );
  }
  this.resStoreApp= function(){
	new PageOff_HtmlApp().write("Item successfully saved to database.");
  }
  this.getMaxNum= function( cb ){
	this.sd.getMaxIdDb( [], function(txn, rs){
		if (rs.rows.length>0) cb( rs.rows.item(0)['id'] );
	});
  }
}
//-----
PageOff_ext_cgi = function(){
  this.superStart= this.start;
  this.start= function(){
	this.doCgi();
	this.superStart();
  }
  this.cgi= function(k,def,qy){ var at=(qy+"").split(new RegExp("[\&\?]"+k+"="));
	return (at.length==1)?def:at[1].split("&")[0]; }
  this.doCgi= function(){
	this.showId = this.cgi("id","-1",location);
	this.loadUrl = this.cgi("url", "", location);
	this.clsName = this.cgi("name", "RemCls", location);
	this.addHtmlApp= this.cgi("addhtmlapp","", location);
  }
}

//-----
PageOff_HtmlApp= function(){
  this.text= "This will be displayed.";
  this.start= function(){
	this.write(this.text);
  }
  this.write= function(s){
	document.body.appendChild( document.createElement("div") ).innerHTML=s;
  }
}
//-----
function OOcallback(obj, meth, arg){
	var _privThis = this;
	this.meth = meth;
	this.obj = obj;
	this.arg = arg;
	this.fcn=function(a,b,c,d){_privThis.obj[_privThis.meth](a,b,c,d);}
	this.fcna=function(){_privThis.obj[_privThis.meth](_privThis.arg);}
}
//-----
AppWrapper= function(name){
  this.name= name;
  this.serialize= function(){
	var obj = {name:name};
	obj.code= window[name].toString();
	return JSON.stringify(obj);
  }
  this.deserialize= function(s){
	eval( "obj="+ s );
	this.name= obj.name;
	this.code= obj.code;
	return this;
  }
  this.spawnApp= function(){
	eval( "this.ClsTmp="+ this.code );
	new this.ClsTmp().start();
  }
}

//------------
//2-4-11 JChoy sqllite on iPhone
//5-8-11 JChoy v1.121 DbTableApp

function SqlDb(){
 var $=this;
 $.dbCfg= {name:'custom_sqlite',ver:'1.0',dispName:'ctmsql',max:1000000};
 $.openDb=function( name, ver, dispName, max ){
  var $=this;
  if (max) $.dbCfg= {name:name,ver:ver,dispName:dispName,max:max};
  $.db= openDatabase($.dbCfg.name,$.dbCfg.ver,$.dbCfg.dispName,$.dbCfg.max);
 }
 $.execParamSql=function(sql,aParms,callback){
  var fcn=function(txn){ txn.executeSql(sql,aParms,callback) };
  this.db.transaction( fcn );
 }
}
 
function DbApp(){
 this.version = "v1.113";
 var $=this;
 $.sql= {
   savePup:"INSERT INTO pups (name) VALUES (?);"
   ,getPups:"SELECT * FROM pups ORDER BY name ASC;"
   ,deletePups:"DELETE FROM pups;"
   ,initPups:"CREATE TABLE IF NOT EXISTS pups (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,name TEXT NOT NULL);" 
 }
 $.init=function(dbName, firstSql){
  var $=this;
  $.sd= new SqlDb();
  if (dbName) $.sd.dbCfg.name= $.sd.dbCfg.dispName= dbName;
  $.sd.openDb();
  var sql1= (firstSql)? firstSql : 'initPups';
  if ( $.sql[sql1] )  $.sd.execParamSql( $.sql[sql1] );
  for (var m in $.sql) $[m+'Db']=
   new Function("parms","cb","this.dbAction('"+m+"',parms,cb)");
  //note: will call cb( transaction, results );
 }
 $.dbAction= function( methName, parms, cb ){
  this.sd.execParamSql( $.sql[methName], parms, cb );
 }
}

new PageOff().start();
</script>
